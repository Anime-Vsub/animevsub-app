<template>
  <q-header class="bg-transparent">
    <q-toolbar>
      <svg
        width="60px"
        height="18px"
        viewBox="0 0 82 26"
        version="1.1"
        xmlns="http://www.w3.org/2000/svg"
      >
        <title>画板</title>
        <g
          id="画板"
          stroke="none"
          stroke-width="1"
          fill="none"
          fill-rule="evenodd"
        >
          <g id="logo-顶导">
            <rect
              id="矩形"
              fill="#D8D8D8"
              opacity="0"
              x="0"
              y="0"
              width="82"
              height="26"
            ></rect>
            <path
              d="M40.730699,25.553536 C40.730699,25.6709712 40.8335468,25.7660629 40.9604205,25.7660629 L46.4314792,25.7660629 C46.5583529,25.7660629 46.6612007,25.6709712 46.6612007,25.553536 L46.6612007,0.922970695 C46.6612007,0.805535552 46.5583529,0.710337902 46.4314792,0.710337902 L40.9604205,0.710337902 C40.8335468,0.710337902 40.730699,0.805535552 40.730699,0.922970695 L40.730699,25.553536 Z M0.508790868,25.553536 C0.508790868,25.6709712 0.611638638,25.7660629 0.738512321,25.7660629 L6.20957109,25.7660629 C6.33644478,25.7660629 6.43929255,25.6709712 6.43929255,25.553536 L6.43929255,10.0477555 C6.43929255,9.93032033 6.33644478,9.83522857 6.20957109,9.83522857 L0.738512321,9.83522857 C0.611638638,9.83522857 0.508790868,9.93032033 0.508790868,10.0477555 L0.508790868,25.553536 Z M24.3947744,20.3676149 C20.4314471,21.0880038 16.6121699,18.3688878 15.8809602,14.3064155 C15.1497505,10.2438372 17.7792181,6.35269945 21.7425454,5.63231056 C25.7058728,4.91202756 29.52515,7.63103764 30.2563597,11.6936159 C30.9875694,15.7560882 28.3581018,19.647226 24.3947744,20.3676149 Z M37.1201838,21.5332831 L34.4135803,19.3501966 C34.3577306,19.3051922 34.3213756,19.2433508 34.3074659,19.176956 C34.2934508,19.1104553 34.3017755,19.0394012 34.3353908,18.9758655 C35.6298395,16.5317532 36.1463967,13.6516801 35.6185642,10.7189783 C34.3684791,3.7734679 27.7362732,-0.835729119 20.8051133,0.424077827 C13.8739534,1.68377888 9.26867052,8.33554261 10.5187557,15.281053 C11.7688408,22.2264576 18.4010467,26.8356546 25.3322066,25.5759535 C27.259127,25.2256601 29.0057477,24.458043 30.4972511,23.3837603 C30.6074752,23.3044465 30.7560565,23.3068821 30.8617495,23.3921258 L33.7649861,25.7338397 C33.863408,25.8132594 34.0091441,25.7951517 34.0903897,25.6933887 L37.15127,21.8613391 C37.2325155,21.7595761 37.2186057,21.6127027 37.1201838,21.5332831 Z M81.7702785,0.710390848 L76.2992198,0.710390848 C76.1723461,0.710390848 76.0694983,0.805588498 76.0694983,0.922917749 L76.0694983,25.553589 C76.0694983,25.6709182 76.1723461,25.7661159 76.2992198,25.7661159 L81.7702785,25.7661159 C81.8971522,25.7661159 82,25.6709182 82,25.553589 L82,0.922917749 C82,0.805588498 81.8971522,0.710390848 81.7702785,0.710390848 Z M3.47406278,0.219238745 C1.55536177,0.219238745 0,1.78221685 0,3.71031342 C0,5.63840998 1.55536177,7.20138809 3.47406278,7.20138809 C5.3927638,7.20138809 6.94812556,5.63840998 6.94812556,3.71031342 C6.94812556,1.78221685 5.3927638,0.219238745 3.47406278,0.219238745 Z M73.1731639,0.710390848 L67.3432971,0.710390848 C67.242873,0.710390848 67.1504575,0.761642976 67.1032487,0.843815808 L61.6862482,10.5227377 C61.6862482,10.5227377 61.656639,10.5774628 61.6129513,10.5921373 L61.5934113,10.5956979 C61.5528675,10.594586 61.5209779,10.5541019 61.507567,10.5339293 L61.5006797,10.5227377 L61.5006797,10.5227377 L56.0836792,0.843815808 C56.0364704,0.761642976 55.9440549,0.710390848 55.8435255,0.710390848 L50.013764,0.710390848 C49.8578063,0.710390848 49.6786657,0.871877407 49.8068039,1.11288948 L58.4715178,15.7632678 C58.5544494,15.9047406 58.5981807,16.0659095 58.5981807,16.2301492 L58.5981807,25.51102 C58.5981807,25.6518575 58.7117769,25.7661159 58.8520335,25.7661159 L64.3348945,25.7661159 C64.4750456,25.7661159 64.5887472,25.6518575 64.5887472,25.51102 L64.5887472,16.2301492 C64.5887472,16.0659095 64.6324786,15.9047406 64.7154101,15.7632678 L73.380124,1.11288948 C73.5081568,0.871877407 73.3290162,0.710390848 73.1731639,0.710390848 Z"
              id="形状"
              fill="#00DC5A"
            ></path>
          </g>
        </g>
      </svg>

      <q-space />
      <SearchBtn />
      <q-btn flat round dense icon="account_circle" />
    </q-toolbar>
  </q-header>

  <div v-if="loading || !data" class="mt-[-50px] loader">
    <div class="swiper-hot">
      <q-responsive :ratio="aspectRatio" class="poster">
        <q-skeleton type="rect" width="100%" height="100%" />
      </q-responsive>
    </div>

    <div class="row text-grey text-[14px] mx-4 text-center mb-4">
      <div class="col-4 relative py-2">
        <q-skeleton type="circle" size="40px" class="mx-auto mb-2" />
        <q-skeleton
          type="text"
          width="3.5rem"
          height="1rem"
          class="mt-2 mx-auto"
        />
      </div>
      <div class="col-4 relative py-2">
        <q-skeleton type="circle" size="40px" class="mx-auto mb-2" />
        <q-skeleton
          type="text"
          width="3.5rem"
          height="1rem"
          class="mt-2 mx-auto"
        />
      </div>
      <div class="col-4 relative py-2">
        <q-skeleton type="circle" size="40px" class="mx-auto mb-2" />
        <q-skeleton
          type="text"
          width="3.5rem"
          height="1rem"
          class="mt-2 mx-auto"
        />
      </div>
    </div>

    <div class="px-4 mt-4">
      <div class="wpa-grid">
        <div class="ctnr">
          <SkeletonCard
            v-for="item in 12"
            :key="item"
            class="card-wrap inline-block"
          />
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <q-skeleton type="text" width="7rem" class="text-h6" />

      <SkeletonGridCard :count="6" />
    </div>

    <div class="px-4 mt-4">
      <q-skeleton type="text" width="7rem" class="text-h6" />

      <div class="wpa-grid">
        <div class="ctnr">
          <SkeletonCard
            v-for="item in 12"
            :key="item"
            class="card-wrap inline-block"
          />
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <q-skeleton type="text" width="7rem" class="text-h6" />

      <div class="wpa-grid">
        <q-skeleton type="text" width="100%" />
        <div class="ctnr">
          <SkeletonCard
            v-for="item in 12"
            :key="item"
            class="card-wrap inline-block"
          />
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <q-skeleton type="text" width="7rem" class="text-h6" />

      <SkeletonGridCard :count="6" />
    </div>
  </div>
  <div v-else class="mt-[-50px]">
    <swiper
      :slides-per-view="1"
      :space-between="0"
      :modules="[Autoplay]"
      :autoplay="{
        delay: 5000,
        disableOnInteraction: false,
      }"
      class="swiper-hot"
    >
      <swiper-slide v-for="(item, index) in data.carousel" :key="index">
        <q-img :ratio="aspectRatio" :src="item.image!" class="poster" />
        <div class="drop-left"></div>
        <div class="drop-center"></div>
        <div class="drop-right"></div>
        <div class="info">
          <div class="flex line-clamp-2 items-center">
            <Quality>{{ item.quality }}</Quality>
            <div class="text-weight-medium">{{ item.name }}</div>
          </div>
          <div class="focus-item-info">
            <span class="focus-item-score">
              <Star />
              {{ item.rate }}
            </span>
            <span class="focus-item-year">{{ item.year }}</span>
            <span class="focus-item-update">
              {{ item.process }}
            </span>
          </div>
          <div class="focus-item-tags" v-if="item.genre.length > 0">
            <template v-for="(tag, index) in item.genre" :key="tag.name">
              <router-link class="c--main" :to="tag.path">{{
                tag.name
              }}</router-link>
              <template v-if="index < item.genre.length - 1">, </template>
            </template>
          </div>
          <div class="focus-item-desc">
            {{ item.description }}
          </div>
        </div>
      </swiper-slide>
    </swiper>

    <div class="row text-grey text-[12px] mx-4 text-center mb-4">
      <router-link to="/muc-luc" class="col-4 relative py-2" v-ripple>
        <img src="~assets/icon_tool_alp.png" width="30" class="mx-auto mb-2" />
        <span class="mt-2">Mục lục</span>
      </router-link>
      <router-link to="/lich-chieu-phim" class="col-4 relative py-2" v-ripple>
        <img src="~assets/icon_tool_calc.png" width="30" class="mx-auto mb-2" />
        <span>Lịch chiếu</span>
      </router-link>
      <router-link to="/bang-xep-hang" class="col-4 relative py-2" v-ripple>
        <img src="~assets/icon_tool_rank.png" width="30" class="mx-auto mb-2" />
        <span>Bảng xếp hạng</span>
      </router-link>
    </div>

    <div class="px-4">
      <div class="wpa-grid">
        <div class="ctnr">
          <Card
            v-for="item in data.thisSeason"
            :key="item.name"
            class="card-wrap"
            :data="item"
          />
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <h2 class="text-h6">Đề xuất</h2>

      <GridCard :items="data.nominate" />
    </div>

    <div class="px-4 mt-4">
      <h2 class="text-h6">Top</h2>

      <div class="wpa-grid">
        <div class="ctnr">
          <Card
            v-for="(item, index) in data.hotUpdate"
            :key="item.name"
            class="card-wrap"
            :data="item"
            :trending="index + 1"
          />
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <h2 class="text-h6">Sắp chiếu</h2>

      <div class="wpa-grid">
        <div class="ctnr">
          <div
            v-for="item in data.preRelease"
            :key="item.name"
            class="relative card-wrap"
          >
            <div class="coming_soon-timeline absolute top-0 left-0">
              <div class="coming_soon-line"></div>
              <div class="coming_soon-dot"></div>
              <div class="coming_soon-time-wrapper">
                <div
                  v-if="
                    (tmp = item.time_release ? dayjs(item.time_release) : null)
                  "
                >
                  <!-- if in today or tomorrow -->
                  <template
                    v-if="(isTodayF = tmp.isToday()) || tmp.isTomorrow()"
                  >
                    <div class="coming_soon-text-date">
                      {{ tmp.format("HH:mm") }}
                    </div>
                    <div class="coming_soon-text-day">
                      <template v-if="isTodayF"> Hôm nay </template>
                      <template v-else> Ngày mai </template>
                    </div>
                  </template>
                  <template v-else>
                    <div class="coming_soon-text-date">
                      {{
                        tmp.format(
                          tmp.year() === new Date().getFullYear()
                            ? "M-DD"
                            : "YYYY-MM-DD"
                        )
                      }}
                    </div>
                    <div class="coming_soon-text-day capitalize">
                      {{ tmp.locale("vi").format("dddd") }}
                    </div>
                  </template>

                  <!-- <template v-else>{{ tmp.format("DD/MM") }}</template> -->
                </div>
                <span v-else class="coming_soon-text-unknown">Sắp chiếu</span>
              </div>
            </div>

            <Card :data="item" />
          </div>
        </div>
      </div>
    </div>

    <div class="px-4 mt-4">
      <h2 class="text-h6">Mới cập nhật</h2>

      <GridCard :items="data.lastUpdate" />
    </div>
  </div>
</template>

<script setup lang="ts">
// eslint-disable-next-line import/order
import { Index } from "src/apis/runs/index"
// eslint-disable-next-line import/order
import { useRequest } from "vue-request"
// eslint-disable-next-line import/order
import Star from "components/Star.vue"
import Card from "components/Card.vue"
// eslint-disable-next-line import/order
import isTomorrow from "dayjs/plugin/isTomorrow"
import "dayjs/locale/vi"
import GridCard from "components/GridCard.vue"
import Quality from "components/Quality.vue"
import SearchBtn from "components/SearchBtn.vue"
import SkeletonCard from "components/SkeletonCard.vue"
import SkeletonGridCard from "components/SkeletonGridCard.vue"
import dayjs from "dayjs"
// eslint-disable-next-line import/order
import isToday from "dayjs/plugin/isToday"

// Import Swiper Vue.js components

import { Autoplay } from "swiper"
import { Swiper, SwiperSlide } from "swiper/vue"
import { watch } from "vue"
import { useRoute, useRouter } from "vue-router"

// Import Swiper styles
import "swiper/css"
import "swiper/css/pagination"
import "swiper/css/autoplay"
import "swiper/css/grid"

dayjs.extend(isToday)
dayjs.extend(isTomorrow)

const route = useRoute()
const router = useRouter()

const aspectRatio = 622 / 350

const { data, loading, error } = useRequest(() => Index())
watch(error, (error) => {
  if (error)
    router.push({
      name: "not_found",
      params: { pathMatch: route.path },
      query: {
        message: error.message,
        cause: error.cause + "",
      },
    })
})

// eslint-disable-next-line functional/no-let, @typescript-eslint/no-explicit-any
let tmp: any
// eslint-disable-next-line functional/no-let, prefer-const
let isTodayF = false
</script>

<style lang="scss" scoped>
.swiper-hot {
  position: relative;
  overflow: hidden;
  margin-bottom: -15.5%;
  cursor: pointer;
  z-index: 0;
  height: 56vw;
  max-height: 1012px;
  @media screen and (max-width: 767px) {
    margin-bottom: 16px;
    height: auto;

    .poster {
      height: max(calc(100vw / v-bind("aspectRatio")), 40vh, 56vw);
    }
  }
  @media screen and (max-width: 1023px) and (min-width: 768px) {
    margin-bottom: -8.59%;
  }

  .drop {
    &-left {
      position: absolute;
      left: 0;
      top: 0;
      width: 30%;
      height: 100%;
      background: linear-gradient(
        269deg,
        rgba(20, 30, 51, 0) 1%,
        rgba(20, 30, 51, 0.02) 10%,
        rgba(20, 30, 51, 0.05) 18%,
        rgba(20, 30, 51, 0.12) 25%,
        rgba(20, 30, 51, 0.2) 32%,
        rgba(20, 30, 51, 0.29) 38%,
        rgba(20, 30, 51, 0.39) 44%,
        rgba(20, 30, 51, 0.5) 50%,
        rgba(20, 30, 51, 0.61) 57%,
        rgba(20, 30, 51, 0.71) 63%,
        rgba(20, 30, 51, 0.8) 69%,
        rgba(20, 30, 51, 0.88) 76%,
        rgba(20, 30, 51, 0.95) 83%,
        rgba(20, 30, 51, 0.98) 91%,
        rgb(20, 30, 51) 100%
      );
      z-index: 101;

      @media screen and (max-width: 767px) {
        display: none;
      }
    }
    &-center {
      position: absolute;
      left: 0px;
      top: 0px;
      width: 100%;
      height: 120px;
      opacity: 0.7;
      background-image: linear-gradient(
        179.5deg,
        rgba(17, 19, 25, 0.88) 0%,
        rgba(17, 19, 25, 0.89) 9%,
        rgba(17, 19, 25, 0.85) 17%,
        rgba(17, 19, 25, 0.79) 24%,
        rgba(17, 19, 25, 0.72) 31%,
        rgba(17, 19, 25, 0.64) 37%,
        rgba(17, 19, 25, 0.55) 44%,
        rgba(17, 19, 25, 0.45) 50%,
        rgba(17, 19, 25, 0.35) 56%,
        rgba(17, 19, 25, 0.26) 63%,
        rgba(17, 19, 25, 0.18) 69%,
        rgba(17, 19, 25, 0.11) 76%,
        rgba(17, 19, 25, 0.05) 83%,
        rgba(17, 19, 25, 0.01) 91%,
        rgba(17, 19, 25, 0) 100%
      );
    }
    &-right {
      position: absolute;
      right: 0;
      top: 0;
      width: 15%;
      height: 100%;
      background: linear-gradient(
        90deg,
        rgba(20, 30, 51, 0) 1%,
        rgba(20, 30, 51, 0.02) 10%,
        rgba(20, 30, 51, 0.05) 18%,
        rgba(20, 30, 51, 0.12) 25%,
        rgba(20, 30, 51, 0.2) 32%,
        rgba(20, 30, 51, 0.29) 38%,
        rgba(20, 30, 51, 0.39) 44%,
        rgba(20, 30, 51, 0.5) 50%,
        rgba(20, 30, 51, 0.61) 57%,
        rgba(20, 30, 51, 0.71) 63%,
        rgba(20, 30, 51, 0.8) 69%,
        rgba(20, 30, 51, 0.88) 76%,
        rgba(20, 30, 51, 0.95) 83%,
        rgba(20, 30, 51, 0.98) 91%,
        rgb(20, 30, 51) 100%
      );
      z-index: 101;

      @media screen and (max-width: 1808px) {
        display: none;
      }
    }
  }

  .info {
    position: absolute;
    bottom: 0;
    left: 0;
    z-index: 10;
    color: rgb(255, 255, 255);
    width: 100%;
    padding: 60px 30px calc(32% + 24px + 3.5vw) (30px + 64);
    // padding-top: 0;
    background-image: linear-gradient(
      -180deg,
      rgba(0, 0, 0, 0) 0,
      #000000 100%
    );

    @media screen and (max-width: 1023px) and (min-width: 768px) {
      padding: {
        left: 56px;
        bottom: calc(18% + 16px + 36px);
      }
    }
    @media screen and (max-width: 767px) {
      padding: {
        bottom: 20px;
        left: 15px;
      }
    }

    .focus-item-info {
      font-weight: 500;
      margin-top: 12px;
      display: flex;
      font-size: 12px;
      align-items: center;
      .focus-item-score {
        font-size: 14px;
        color: rgb(0, 194, 52); //  rgb(0, 214, 57);
        font-weight: 700;
        svg {
          width: 12px;
          height: 12px;
          margin-right: 4px;
        }
      }
      .focus-item-year,
      .focus-item-update {
        // text-shadow: rgb(0 0 0 / 50%) 0px 1px 2px;
      }

      .focus-item-score,
      .focus-item-year {
        display: inline-flex;
        line-height: 17px;
        align-items: center;

        &:after {
          content: "";
          margin: 0px 6px;
          height: 10px;
          width: 2px;
          background: rgba(255, 255, 255, 0.2);
        }
      }
    }
    .focus-item-tags {
      margin-top: 13px;
      font-size: 12px;
      line-height: 16px;
      color: rgb(236, 236, 236);
      font-weight: 500;
      text-shadow: rgb(0 0 0 / 50%) 0px 1px 2px;
      span {
        display: inline-block;
        margin-right: 6px;
        padding: 0px 5px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 2px;
      }
    }
    .focus-item-desc {
      width: 31.25vw;
      min-width: 320px;
      overflow: hidden;
      height: 32px;
      line-height: 16px;
      margin-top: 12px;
      font-size: 14px;
      display: -webkit-box;
      text-overflow: ellipsis;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      text-shadow: rgb(0 0 0 / 50%) 0px 1px 2px;
      font-weight: 400; //500;
      @media screen and (max-width: 1023px) and (min-width: 768px) {
        font-size: 12px;
      }
    }
  }
}
</style>

<style lang="scss" scoped>
.coming_soon {
  &-timeline {
    @apply relative mt-[6px] mb-[14px];

    @media screen and (max-width: 767px) {
      @apply mb-[6px] flex items-center;
      @apply mr-[-8px];
    }
  }
  &-line {
    @apply w-[calc(100%+16px)] h-[2px] bg-[rgb(45,47,52)];
    @media screen and (max-width: 767px) {
      @apply w-full;
    }
    @media screen and (max-width: 767px) {
      order: 2;
    }
  }
  &-dot {
    @apply w-[10px] h-[10px] mx-auto mt-[-6px];
    background: rgb(130, 131, 135);
    border: 2px solid rgb(17, 19, 25);
    border-radius: 50%;

    @media screen and (max-width: 767px) {
      display: none;
    }
  }
  &-time-wrapper {
    @media screen and (max-width: 767px) {
      order: 1;
    }
    @apply text-center h-[42px] mt-4;
    // @apply absolute;

    @media screen and (max-width: 767px) {
      @apply flex items-center ml-[-14px];
      // position: absolute;
      height: 30px;
      margin: 0;
      padding-right: 8px;
      padding-left: 8px;
      text-align: left;
      font-size: 11px;
      color: rgb(188, 189, 190);
      white-space: nowrap;
    }
  }
}
.coming_soon-text {
  &-date {
    font-size: 14px;
    color: rgb(188, 189, 190);

    @media screen and (max-width: 767px) {
      display: inline-block;
      padding: 0px 2px;
      margin-left: -2px;
      background: rgb(17, 19, 25);
      font-size: 12px;
    }
  }
  &-day {
    font-size: 14px;
    color: rgb(130, 131, 135);

    @media screen and (max-width: 767px) {
      font-size: 12px;
    }
  }
  &-unknown {
    font-size: 14px;
    color: rgb(188, 189, 190);

    @media screen and (min-width: 768px) and (max-width: 1023px) {
      font-size: 12px;
      line-height: 0;
    }
  }
}
</style>

<style lang="scss" scoped>
.wpa-grid {
  //  display: flex;
  overflow-x: scroll;
  position: relative;
  .ctnr {
    max-width: initial;
    white-space: nowrap;
  }
}
.card-wrap {
  $offset: 0.1;
  display: inline-block;
  white-space: initial;

  width: 280px;
  // class="col-4 col-lg-3 col-xl-2 px-[5px] py-2"
  max-width: calc((100% - 16px) / #{3 + $offset});
  margin-right: 8px;

  @media (min-width: $breakpoint-lg-min) {
    max-width: calc((100% - 48px) / #{4 + $offset});
    margin-right: 24px;
  }
  @media (min-width: $breakpoint-xl-min) {
    max-width: calc((100% - 80px) / #{6 + $offset});
    margin-right: 40px;
  }
}

.loader .wpa-grid {
  overflow-x: hidden;
}
</style>
